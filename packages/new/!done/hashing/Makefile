# ğŸ› ï¸ Makefile for hashing Package
# Provides build automation and development tools

.PHONY: help build test clean lint fmt vet security coverage dev-setup

# Default target
help: ## ğŸ“š Show this help message
	@echo "ğŸ› ï¸  Available targets for hashing:"
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "  \033[36m%-15s\033[0m %s\n", $$1, $$2}'

# Determine if we're in src structure or not
WORKING_DIR := $(shell if [ -f "src/go.mod" ]; then echo "src"; else echo "."; fi)

build: ## ğŸ”¨ Build the package
	@echo "ğŸ”¨ Building hashing..."
	@cd $(WORKING_DIR) && go build -v ./...

test: ## ğŸ§ª Run tests with coverage
	@echo "ğŸ§ª Running tests for hashing..."
	@mkdir -p coverage
	@cd $(WORKING_DIR) && go test -v -race -coverprofile=../coverage/coverage.out -covermode=atomic ./...
	@cd $(WORKING_DIR) && go tool cover -func=../coverage/coverage.out

test-short: ## âš¡ Run tests without coverage
	@echo "âš¡ Running quick tests for hashing..."
	@cd $(WORKING_DIR) && go test -v -short ./...

clean: ## ğŸ§¹ Clean build artifacts and cache
	@echo "ğŸ§¹ Cleaning hashing..."
	@cd $(WORKING_DIR) && go clean -cache -testcache -modcache
	@rm -rf coverage/

lint: ## ğŸ” Run golangci-lint
	@echo "ğŸ” Linting hashing..."
	@if command -v golangci-lint >/dev/null 2>&1; then \
		cd $(WORKING_DIR) && golangci-lint run; \
	else \
		echo "âš ï¸  golangci-lint not installed. Run 'make dev-setup' first."; \
	fi

fmt: ## ğŸ¨ Format code
	@echo "ğŸ¨ Formatting hashing..."
	@cd $(WORKING_DIR) && go fmt ./...

vet: ## ğŸ” Run go vet
	@echo "ğŸ” Running go vet for hashing..."
	@cd $(WORKING_DIR) && go vet ./...

security: ## ğŸ”’ Run security scans
	@echo "ğŸ”’ Running security scans for hashing..."
	@if command -v gosec >/dev/null 2>&1; then \
		cd $(WORKING_DIR) && gosec ./...; \
	else \
		echo "âš ï¸  gosec not installed. Run 'make dev-setup' first."; \
	fi
	@if command -v govulncheck >/dev/null 2>&1; then \
		cd $(WORKING_DIR) && govulncheck ./...; \
	else \
		echo "âš ï¸  govulncheck not installed. Run 'make dev-setup' first."; \
	fi

coverage: test ## ğŸ“Š Generate coverage report
	@echo "ğŸ“Š Generating coverage report for hashing..."
	@cd $(WORKING_DIR) && go tool cover -html=../coverage/coverage.out -o ../coverage/coverage.html
	@echo "ğŸ“Š Coverage report: coverage/coverage.html"

dev-setup: ## ğŸ› ï¸ Install development tools
	@echo "ğŸ› ï¸ Installing development tools for hashing..."
	@cd $(WORKING_DIR) && go install github.com/golangci/golangci-lint/cmd/golangci-lint@latest
	@cd $(WORKING_DIR) && go install github.com/securecodewarrior/gosec/cmd/gosec@latest
	@cd $(WORKING_DIR) && go install golang.org/x/vuln/cmd/govulncheck@latest
	@echo "âœ… Development tools installed"

all: clean fmt vet lint test security ## ğŸš€ Run complete CI pipeline
	@echo "ğŸ‰ All checks passed for hashing!"

# Dependencies
deps: ## ğŸ“¥ Download dependencies
	@echo "ğŸ“¥ Downloading dependencies for hashing..."
	@cd $(WORKING_DIR) && go mod download
	@cd $(WORKING_DIR) && go mod tidy

update-deps: ## â¬†ï¸ Update dependencies
	@echo "â¬†ï¸ Updating dependencies for hashing..."
	@cd $(WORKING_DIR) && go get -u ./...
	@cd $(WORKING_DIR) && go mod tidy
